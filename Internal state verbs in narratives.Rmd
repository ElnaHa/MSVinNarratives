---
title: "Internal state verbs in narratives"
output: pdf_document
date: "2025-08-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages
```{r message=FALSE, warning=FALSE}
library(readxl)
library(readr)
library(dplyr)
library(brms)
library(ggplot2)
library(bayesplot)
library(emmeans)
library(forcats)
library(patchwork)
library(flextable)
library(officer)
```

# Data preparation for modeling
```{r}
# load data
d <- read_xls("internal_state_verbs.xlsx")
# # bring columns to correct form
# d$id <- as.factor(d$id)
# d$narrative_genre <- as.factor(d$narrative_genre)
# d$story <- as.factor(d$story)
# d$internal_state_category <- as.factor(d$internal_state_category)
# d$c_age <- d$age - mean(d$age)
# 
# # contrast code categorical predictors
# contrasts(d$narrative_genre) <- contr.sum(2) # GT = 1, MAIN = -1
# contrasts(d$internal_state_category) <- contr.sum(5) # "sociorelational" = left out
```

# Before we ran the models, we checked if scores for internal state category varied between stories via model comparison. 
```{r}
# #model comparison to check if internal_state_category is different between stories for types ratio
# base <- brm(types|trials(total_words) ~ narrative_genre*internal_state_category +
#               narrative_genre*c_age + internal_state_category*c_age + (1|id)+ (1|story),
#             data = d,
#             family = binomial(),
#             prior = c(prior(normal(0,10), class="Intercept"),
#                       prior(normal(0,10), class="b")),
#             cores = 4, chains = 4, iter = 8000)
# 
# slope_cor <- brm(types|trials(total_words) ~ narrative_genre*internal_state_category +
#                    narrative_genre*c_age + internal_state_category*c_age +
#                    (1|id) + (1+internal_state_category|story),
#                  data = d,
#                  family = binomial(),
#                  prior = c(prior(normal(0,10), class="Intercept"),
#                            prior(normal(0,10), class="b"),
#                            prior(lkj(2), class="cor")),
#                  cores = 4, chains = 4, iter = 8000)
# 
# slope_uncor <- brm(types|trials(total_words) ~ narrative_genre*internal_state_category +
#                      narrative_genre*c_age + internal_state_category*c_age +
#                      (1|id) + (1+internal_state_category||story),
#                    data = d,
#                    family = binomial(),
#                    prior = c(prior(normal(0,10), class="Intercept"),
#                              prior(normal(0,10), class="b")),
#                    cores = 4, chains = 4, iter = 8000)
# 
# # add LOO to each fit
# base <- add_criterion(base, "loo")
# slope_cor <- add_criterion(slope_cor, "loo")
# slope_uncor <- add_criterion(slope_uncor, "loo")
# 
# # compare
# loo_compare(slope_cor, slope_uncor, base) # moderate evidence for using the slope_cor model: diff = 1.5 x sd
# 
# 
# #model comparison to check if internal_state_category is different between stories for tokens ratio
# 
# base2 <- brm(tokens|trials(total_words) ~ narrative_genre*internal_state_category +
#               narrative_genre*c_age + internal_state_category*c_age + (1|id)+ (1|story),
#             data = d,
#             family = binomial(),
#             prior = c(prior(normal(0,10), class="Intercept"),
#                       prior(normal(0,10), class="b")),
#             cores = 4, chains = 4, iter = 8000)
# 
# slope_cor2 <- brm(tokens|trials(total_words) ~ narrative_genre*internal_state_category +
#                    narrative_genre*c_age + internal_state_category*c_age +
#                    (1|id) + (1+internal_state_category|story),
#                  data = d,
#                  family = binomial(),
#                  prior = c(prior(normal(0,10), class="Intercept"),
#                            prior(normal(0,10), class="b"),
#                            prior(lkj(2), class="cor")),
#                  cores = 4, chains = 4, iter = 8000)
# 
# slope_uncor2 <- brm(tokens|trials(total_words) ~ narrative_genre*internal_state_category +
#                      narrative_genre*c_age + internal_state_category*c_age +
#                      (1|id) + (1+internal_state_category||story),
#                    data = d,
#                    family = binomial(),
#                    prior = c(prior(normal(0,10), class="Intercept"),
#                              prior(normal(0,10), class="b")),
#                    cores = 4, chains = 4, iter = 8000)
# 
# # add LOO to each fit
# base2 <- add_criterion(base2, "loo")
# slope_cor2 <- add_criterion(slope_cor2, "loo", moment_match = TRUE)
# slope_uncor2 <- add_criterion(slope_uncor2, "loo", moment_match = TRUE)
# 
# # compare
# loo_compare(slope_cor2, slope_uncor2, base2) # evidence for using the slope_cor model: diff = 2 x sd

```

# Variation: model for types of ISV 
```{r}
## dependant variable: How often do they use internal state types, out of the total words produced?
## independant variable:
### narrative_genre: Do children use ISVs differently between narrative genres?
### internal_state_category: Do children use ISVs differently between categories?
### narrative_genre*internal_state_category: Do children use different categories of internal state verbs depending on the narrative genre?
## random effects
### (1 | id): Random intercept for each child — controls for individual differences in overall internal state verb use.
### (1 + internal_state_category | story): Random intercept and slope by story: allowing different stories to have different average levels of internal state verb use, and also different effects of internal state category.

m_type <- slope_cor
saveRDS(m_type, "m_type.RDS")


plot(m_type) # no convergence problems visible

fixef(m_type)
summary(m_type)
```

## Extract posterior samples and calculate the missing level coefficients
```{r}
# # Extract posterior samples
# arr_m_type<-as.mcmc(m_type,combine_chains=TRUE)
# intercept_m_type <- arr_m_type[, "b_Intercept"]
# b_c_age_m_type <- arr_m_type[, "b_c_age"]
# b_narrative_genre1__m_type <- arr_m_type[, "b_narrative_genre1"]
# b_internal_state_category1__m_type <- arr_m_type[, "b_internal_state_category1"]
# b_internal_state_category2__m_type <- arr_m_type[, "b_internal_state_category2"]
# b_internal_state_category3__m_type <- arr_m_type[, "b_internal_state_category3"]
# b_internal_state_category4__m_type <- arr_m_type[, "b_internal_state_category4"]
# 
# b_narrative_genre1_internal_state_category1__m_type <- arr_m_type[,
# "b_narrative_genre1:internal_state_category1"]
# b_narrative_genre1_internal_state_category2__m_type <- arr_m_type[, "b_narrative_genre1:internal_state_category2"]
# b_narrative_genre1_internal_state_category3__m_type <- arr_m_type[, "b_narrative_genre1:internal_state_category3"]
# b_narrative_genre1_internal_state_category4__m_type <- arr_m_type[, "b_narrative_genre1:internal_state_category4"]
# 
# b_internal_state_category1_c_age__m_type <- arr_m_type[, "b_internal_state_category1:c_age"]
# b_internal_state_category2_c_age__m_type <- arr_m_type[, "b_internal_state_category2:c_age"]
# b_internal_state_category3_c_age__m_type <- arr_m_type[, "b_internal_state_category3:c_age"]
# b_internal_state_category4_c_age__m_type <- arr_m_type[, "b_internal_state_category4:c_age"]
# 
# # Calculate posterior samples for the missing levels
# b_internal_state_category5__m_type <- -(b_internal_state_category1__m_type + b_internal_state_category2__m_type + b_internal_state_category3__m_type + b_internal_state_category4__m_type)
# b_narrative_genre1_internal_state_category5__m_type <- -(b_narrative_genre1_internal_state_category1__m_type + b_narrative_genre1_internal_state_category2__m_type + b_narrative_genre1_internal_state_category3__m_type + b_narrative_genre1_internal_state_category4__m_type)
# b_internal_state_category5_c_age__m_type <- -(b_internal_state_category1_c_age__m_type + b_internal_state_category2_c_age__m_type + b_internal_state_category3_c_age__m_type + b_internal_state_category4_c_age__m_type)
# 
# # Calculate estimates and credible intervals
# est_b_internal_state_category5__m_type <- mean(b_internal_state_category5__m_type)
# ci_b_internal_state_category5__m_type <- quantile(b_internal_state_category5__m_type, c(0.025, 0.975))
# 
# est_b_narrative_genre1_internal_state_category5__m_type <- mean(b_narrative_genre1_internal_state_category5__m_type)
# ci_b_narrative_genre1_internal_state_category5__m_type <- quantile(b_narrative_genre1_internal_state_category5__m_type, c(0.025, 0.975))
# 
# est_b_internal_state_category5_c_age__m_type <- mean(b_internal_state_category5_c_age__m_type)
# ci_b_internal_state_category5_c_age__m_type <- quantile(b_internal_state_category5_c_age__m_type, c(0.025, 0.975))
# 
# # Print the results
# missing_levels_m_type <- list(
#   internal_state_category5__m_type = list(estimate = est_b_internal_state_category5__m_type, CI = ci_b_internal_state_category5__m_type),
#   narrative_genre1_internal_state_category5__m_type = list(estimate = est_b_narrative_genre1_internal_state_category5__m_type, CI = ci_b_narrative_genre1_internal_state_category5__m_type),
#   internal_state_category5_c_age__m_type = list(estimate = est_b_internal_state_category5_c_age__m_type, CI = ci_b_internal_state_category5_c_age__m_type))
# 

missing_levels_m_type # main effect of sociorelational
```

# Frequency: model for tokens of ISV 
```{r}
## dependant variable: How often do they use internal state types, out of the total words produced?
## independant variable:
### narrative_genre: Do children use ISVs differently between narrative genres?
### internal_state_category: Do children use ISVs differently between categories?
### narrative_genre*internal_state_category: Do children use different categories of internal state verbs depending on the narrative genre?
## random effects
### (1 | id): Random intercept for each child — controls for individual differences in overall internal state verb use.
### (1 + internal_state_category | story): Random intercept and slope by story: allowing different stories to have different average levels of internal state verb use, and also different effects of internal state category.


# m_token <- slope_cor2
# 
# saveRDS(m_token, "m_token.RDS")

m_token <- readRDS("m_token.RDS")

plot(m_token) # no convergence problems visible

summary(m_token)
fixef(m_token)
```

## Extract posterior samples and calculate the missing level coefficients
```{r}
# # Extract posterior samples
# arr_m_token<-as.mcmc(m_token,combine_chains=TRUE)
# intercept_m_token <- arr_m_token[, "b_Intercept"]
# b_c_age_m_token <- arr_m_token[, "b_c_age"]
# b_narrative_genre1__m_token <- arr_m_token[, "b_narrative_genre1"]
# b_internal_state_category1__m_token <- arr_m_token[, "b_internal_state_category1"]
# b_internal_state_category2__m_token <- arr_m_token[, "b_internal_state_category2"]
# b_internal_state_category3__m_token <- arr_m_token[, "b_internal_state_category3"]
# b_internal_state_category4__m_token <- arr_m_token[, "b_internal_state_category4"]
# 
# b_narrative_genre1_internal_state_category1__m_token <- arr_m_token[,
# "b_narrative_genre1:internal_state_category1"]
# b_narrative_genre1_internal_state_category2__m_token <- arr_m_token[, "b_narrative_genre1:internal_state_category2"]
# b_narrative_genre1_internal_state_category3__m_token <- arr_m_token[, "b_narrative_genre1:internal_state_category3"]
# b_narrative_genre1_internal_state_category4__m_token <- arr_m_token[, "b_narrative_genre1:internal_state_category4"]
# 
# b_internal_state_category1_c_age__m_token <- arr_m_token[, "b_internal_state_category1:c_age"]
# b_internal_state_category2_c_age__m_token <- arr_m_token[, "b_internal_state_category2:c_age"]
# b_internal_state_category3_c_age__m_token <- arr_m_token[, "b_internal_state_category3:c_age"]
# b_internal_state_category4_c_age__m_token <- arr_m_token[, "b_internal_state_category4:c_age"]
# 
# # Calculate posterior samples for the missing levels
# b_internal_state_category5__m_token <- -(b_internal_state_category1__m_token + b_internal_state_category2__m_token + b_internal_state_category3__m_token + b_internal_state_category4__m_token)
# b_narrative_genre1_internal_state_category5__m_token <- -(b_narrative_genre1_internal_state_category1__m_token + b_narrative_genre1_internal_state_category2__m_token + b_narrative_genre1_internal_state_category3__m_token + b_narrative_genre1_internal_state_category4__m_token)
# b_internal_state_category5_c_age__m_token <- -(b_internal_state_category1_c_age__m_token + b_internal_state_category2_c_age__m_token + b_internal_state_category3_c_age__m_token + b_internal_state_category4_c_age__m_token)
# 
# # Calculate estimates and credible intervals
# est_b_internal_state_category5__m_token <- mean(b_internal_state_category5__m_token)
# ci_b_internal_state_category5__m_token <- quantile(b_internal_state_category5__m_token, c(0.025, 0.975))
# 
# est_b_narrative_genre1_internal_state_category5__m_token <- mean(b_narrative_genre1_internal_state_category5__m_token)
# ci_b_narrative_genre1_internal_state_category5__m_token <- quantile(b_narrative_genre1_internal_state_category5__m_token, c(0.025, 0.975))
# 
# est_b_internal_state_category5_c_age__m_token <- mean(b_internal_state_category5_c_age__m_token)
# ci_b_internal_state_category5_c_age__m_token <- quantile(b_internal_state_category5_c_age__m_token, c(0.025, 0.975))
# 
# # Print the results
# missing_levels_m_token <- list(
#   internal_state_category5__m_token = list(estimate = est_b_internal_state_category5__m_token, CI = ci_b_internal_state_category5__m_token),
#   narrative_genre1_internal_state_category5__m_token = list(estimate = est_b_narrative_genre1_internal_state_category5__m_token, CI = ci_b_narrative_genre1_internal_state_category5__m_token),
#   internal_state_category5_c_age__m_token = list(estimate = est_b_internal_state_category5_c_age__m_token, CI = ci_b_internal_state_category5_c_age__m_token))
# 

missing_levels_m_token # main effect of sociorelational
```

